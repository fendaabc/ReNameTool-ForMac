<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索过滤功能测试</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="src/styles.css">
    <style>
        body { padding: 2rem; }
        .test-section { 
            margin-bottom: 2rem; 
            padding: 1rem; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .test-files {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .test-file {
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>搜索过滤功能测试</h1>
    
    <div class="test-section">
        <h3>测试数据</h3>
        <button id="load-test-data" class="primary">加载测试文件</button>
        <div id="test-files-display" class="test-files"></div>
    </div>

    <!-- 搜索和过滤区域 -->
    <div id="search-filter-section" style="margin-bottom:1rem;">
        <div style="display:grid;grid-template-columns:1fr auto auto;gap:0.8rem;align-items:end;">
            <div>
                <label for="search-input" style="font-size:0.9em;margin-bottom:0.3rem;display:block;">搜索文件</label>
                <input type="text" id="search-input" placeholder="按文件名或扩展名搜索..." aria-describedby="search-help" style="margin-bottom:0;">
                <small id="search-help" class="form-text" style="margin-top:0.2rem;">支持模糊匹配，实时过滤</small>
            </div>
            <div>
                <label for="extension-filter" style="font-size:0.9em;margin-bottom:0.3rem;display:block;">文件类型</label>
                <select id="extension-filter" aria-describedby="filter-help" style="margin-bottom:0;">
                    <option value="">所有类型</option>
                </select>
                <small id="filter-help" class="form-text" style="margin-top:0.2rem;">按扩展名过滤</small>
            </div>
            <div>
                <button id="clear-search" class="outline secondary" style="margin-bottom:0;" title="清除搜索条件" aria-label="清除所有搜索和过滤条件">清除</button>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>文件列表</h3>
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
            <table style="width: 100%; margin: 0;">
                <thead>
                    <tr>
                        <th>选择</th>
                        <th>文件名</th>
                        <th>扩展名</th>
                        <th>大小</th>
                    </tr>
                </thead>
                <tbody id="file-table-body">
                    <tr id="empty-tip-row">
                        <td colspan="4" style="text-align:center;color:var(--pico-secondary);padding:2em 0;">
                            点击"加载测试文件"开始测试
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="test-section">
        <h3>状态信息</h3>
        <div id="status-info">
            <p><strong>总文件数:</strong> <span id="total-count">0</span></p>
            <p><strong>显示文件数:</strong> <span id="displayed-count">0</span></p>
            <p><strong>选中文件数:</strong> <span id="selected-count">0</span></p>
            <p><strong>过滤状态:</strong> <span id="filter-status">无过滤</span></p>
        </div>
    </div>

    <!-- 引入搜索过滤管理器 -->
    <script src="src/search-filter-manager.js"></script>
    
    <script>
        // 模拟文件数据
        const testFiles = [
            { name: 'document.pdf', extension: 'pdf', size: 1024000, selected: false },
            { name: 'image.jpg', extension: 'jpg', size: 2048000, selected: false },
            { name: 'photo.png', extension: 'png', size: 1536000, selected: false },
            { name: 'video.mp4', extension: 'mp4', size: 10240000, selected: false },
            { name: 'music.mp3', extension: 'mp3', size: 5120000, selected: false },
            { name: 'text.txt', extension: 'txt', size: 1024, selected: false },
            { name: 'data.csv', extension: 'csv', size: 2048, selected: false },
            { name: 'presentation.pptx', extension: 'pptx', size: 3072000, selected: false },
            { name: 'spreadsheet.xlsx', extension: 'xlsx', size: 1024000, selected: false },
            { name: 'archive.zip', extension: 'zip', size: 4096000, selected: false },
            { name: 'IMG_001.jpg', extension: 'jpg', size: 1800000, selected: false },
            { name: 'IMG_002.jpg', extension: 'jpg', size: 1900000, selected: false },
            { name: 'backup.tar.gz', extension: 'gz', size: 8192000, selected: false },
            { name: 'script.js', extension: 'js', size: 4096, selected: false },
            { name: 'style.css', extension: 'css', size: 2048, selected: false }
        ];

        // 全局变量
        window.loadedFiles = [];

        // 格式化文件大小
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            let size = bytes;
            while (size >= 1024 && i < units.length - 1) {
                size /= 1024;
                i++;
            }
            return `${size.toFixed(1)} ${units[i]}`;
        }

        // 更新文件表格
        function updateFileTable() {
            const tbody = document.getElementById('file-table-body');
            const emptyRow = document.getElementById('empty-tip-row');
            
            // 获取要显示的文件
            let filesToDisplay = window.loadedFiles;
            if (window.searchFilterManager && window.searchFilterManager.hasActiveFilters()) {
                filesToDisplay = window.searchFilterManager.getDisplayedFiles();
            }

            if (filesToDisplay.length === 0) {
                if (window.loadedFiles.length === 0) {
                    emptyRow.style.display = '';
                    emptyRow.innerHTML = '<td colspan="4" style="text-align:center;color:var(--pico-secondary);padding:2em 0;">点击"加载测试文件"开始测试</td>';
                } else {
                    emptyRow.style.display = '';
                    emptyRow.innerHTML = '<td colspan="4" style="text-align:center;color:var(--pico-secondary);padding:2em 0;">未找到匹配的文件</td>';
                }
                // 清除其他行
                Array.from(tbody.children).forEach(row => {
                    if (row.id !== 'empty-tip-row') {
                        row.remove();
                    }
                });
                return;
            }

            emptyRow.style.display = 'none';
            
            // 清除现有行（除了空提示行）
            Array.from(tbody.children).forEach(row => {
                if (row.id !== 'empty-tip-row') {
                    row.remove();
                }
            });

            // 添加文件行
            filesToDisplay.forEach((file, index) => {
                const row = document.createElement('tr');
                const originalIndex = window.loadedFiles.indexOf(file);
                
                row.innerHTML = `
                    <td><input type="checkbox" ${file.selected ? 'checked' : ''} onchange="toggleFileSelection(${originalIndex})"></td>
                    <td>${file.name}</td>
                    <td>${file.extension}</td>
                    <td>${formatFileSize(file.size)}</td>
                `;
                
                tbody.appendChild(row);
            });

            updateStatusInfo();
        }

        // 切换文件选择状态
        function toggleFileSelection(index) {
            if (window.loadedFiles[index]) {
                window.loadedFiles[index].selected = !window.loadedFiles[index].selected;
                updateStatusInfo();
            }
        }

        // 更新状态信息
        function updateStatusInfo() {
            const totalCount = window.loadedFiles.length;
            const selectedCount = window.loadedFiles.filter(f => f.selected).length;
            
            let displayedCount = totalCount;
            let filterStatus = '无过滤';
            
            if (window.searchFilterManager && window.searchFilterManager.hasActiveFilters()) {
                displayedCount = window.searchFilterManager.getDisplayedFiles().length;
                const stats = window.searchFilterManager.getSearchStats();
                filterStatus = `已过滤 (${stats.searchQuery ? '搜索: "' + stats.searchQuery + '"' : ''}${stats.searchQuery && stats.selectedExtension ? ', ' : ''}${stats.selectedExtension ? '类型: .' + stats.selectedExtension : ''})`;
            }

            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('displayed-count').textContent = displayedCount;
            document.getElementById('selected-count').textContent = selectedCount;
            document.getElementById('filter-status').textContent = filterStatus;
        }

        // 加载测试数据
        document.getElementById('load-test-data').addEventListener('click', () => {
            window.loadedFiles = [...testFiles];
            
            // 显示测试文件
            const display = document.getElementById('test-files-display');
            display.innerHTML = testFiles.map(file => 
                `<div class="test-file">${file.name} (${formatFileSize(file.size)})</div>`
            ).join('');

            // 通知搜索过滤管理器
            if (window.searchFilterManager) {
                window.searchFilterManager.onFilesUpdated();
            }

            updateFileTable();
        });

        // 等待搜索过滤管理器初始化完成
        document.addEventListener('DOMContentLoaded', () => {
            console.log('测试页面已加载');
            
            // 检查搜索过滤管理器是否可用
            setTimeout(() => {
                if (window.searchFilterManager) {
                    console.log('✅ 搜索过滤管理器已可用');
                } else {
                    console.warn('⚠️ 搜索过滤管理器未找到');
                }
            }, 1000);
        });
    </script>
</body>
</html>