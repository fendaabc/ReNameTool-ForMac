<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–‡ä»¶æ‰¹é‡é‡å‘½å - æ‹–æ‹½æµ‹è¯•</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <style>
      body {
        padding: 1rem;
      }
      #drop-zone {
        border: 2px dashed var(--pico-primary);
        padding: 2rem;
        text-align: center;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #drop-zone:hover {
        background-color: rgba(var(--pico-primary-rgb), 0.1);
      }

      #drop-zone button:hover {
        background-color: rgba(var(--pico-primary-rgb), 0.15);
        border-color: var(--pico-primary);
      }
      .preview-highlight {
        color: var(--pico-primary);
        font-weight: bold;
      }
      .dimmed {
        color: var(--pico-secondary);
      }
      main {
  display: grid;
  grid-template-columns: minmax(340px, 2.2fr) minmax(280px, 1fr);
  gap: 1.2rem;
  align-items: start;
  height: 65vh;
  min-height: 380px;
  max-width: 1200px;
  margin: 0 auto;
}

aside {
  max-width: 420px;
  width: 100%;
}

@media (max-width: 1200px) {
  main {
    grid-template-columns: 1.6fr 1fr;
    gap: 0.8rem;
  }
  aside {
    max-width: 100%;
  }
}

@media (max-width: 800px) {
  main {
    display: flex;
    flex-direction: column;
    height: auto;
  }
  aside {
    order: 1;
    max-width: 100%;
    width: 100%;
  }
  section {
    order: 2;
    max-width: 100%;
    width: 100%;
  }
}
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
    <link rel="stylesheet" href="src/styles.css" />
  </head>
  <body>
    <header style="padding-bottom: 0.5rem;">
  <div style="display: flex; align-items: center; justify-content: flex-start; gap:1rem;">
    <img src="favicon.ico" alt="logo" style="width:32px;height:32px;">
    <h2 style="margin: 0;">æ–‡ä»¶æ‰¹é‡é‡å‘½å</h2>
  </div>
</header>
<!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
<button id="theme-toggle" style="position: absolute; top: 18px; right: 22px; background: none; border: none; cursor: pointer; z-index: 99; opacity: 0.74;">
  <span id="theme-icon" aria-label="åˆ‡æ¢ä¸»é¢˜" style="display:inline-block;width:28px;height:28px;vertical-align:middle;">
    <!-- SVG é»˜è®¤æœˆäº® -->
    <svg id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>
  </span>
</button>


    <main>
      <section style="display: flex; flex-direction: column; height:100%;">
        <div id="drop-zone" class="card-group" style="border:2px dashed var(--pico-primary);border-radius:13px;padding:1.5rem 1rem;margin-bottom:1.2rem;background:#fafdff;display:flex;flex-direction:column;align-items:center;gap:0.85rem;transition:background 0.18s;">
  <div style="display:flex;gap:0.7rem;">
    <button id="select-files-btn" class="outline">é€‰æ‹©æ–‡ä»¶</button>
    <button id="select-folder-btn" class="outline">é€‰æ‹©æ–‡ä»¶å¤¹</button>
  </div>
  <span style="font-size:0.98em;color:var(--pico-primary);font-weight:500;">å¯æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹æˆ–ç‚¹å‡»æŒ‰é’®å¯¼å…¥</span>

</div>
<hr style="margin:0.6rem 0 1.1rem 0;border:0;border-top:1.5px dashed #e0e8ef;">

        <div style="flex: 1; display: flex; flex-direction: column;">
          <div class="file-list-scroll" style="flex:1 1 auto;max-height:60vh;min-height:180px;overflow:auto;border-radius:8px;box-shadow:0 1px 6px #0001;">
  <table style="width:100%; font-size: 0.9em;">
    <thead>
      <tr>
        <th colspan="3" id="file-count" style="text-align:left; font-size:0.92em; font-weight:normal; color:var(--pico-secondary); background:transparent;">å·²åŠ è½½ 0 ä¸ªæ–‡ä»¶</th>
      </tr>
      <tr>
        <th scope="col">#</th>
        <th scope="col">åŸæ–‡ä»¶å</th>
        <th scope="col">æ–°æ–‡ä»¶å (é¢„è§ˆ)</th>
      </tr>
    </thead>
    <tbody id="file-table-body">
  <tr id="empty-tip-row">
    <td colspan="3" style="text-align:center;color:var(--pico-secondary);padding:2.5em 0;font-size:1.05em;">æš‚æ— æ–‡ä»¶ï¼Œè¯·æ‹–æ‹½æˆ–é€‰æ‹©æ–‡ä»¶/æ–‡ä»¶å¤¹å¯¼å…¥</td>
  </tr>
</tbody>
  </table>
</div>
        </div>
        
      </section>

      <aside style="display: flex; flex-direction: column; height:100%; justify-content: space-between;">
        <div>
          <hgroup>
            <h4>é‡å‘½åè§„åˆ™</h4>
            <h5 style="margin-bottom:0.5rem;">ä¸€æ¬¡åªå¯é€‰æ‹©å¹¶æ‰§è¡Œä¸€ç§è§„åˆ™</h5>
          </hgroup>

          <nav style="margin-bottom: 1rem;">
  <div class="tab-group" style="display:flex;gap:0.5rem;">
    <button type="button" class="tab-link active" data-tab="tab-replace">æŸ¥æ‰¾æ›¿æ¢</button>
    <button type="button" class="tab-link" data-tab="tab-sequence">æ·»åŠ åºåˆ—</button>
    <button type="button" class="tab-link" data-tab="tab-case">å¤§å°å†™</button>
  </div>
</nav>

          <div id="tab-replace" class="tab-content active">
            <label for="find">æŸ¥æ‰¾å†…å®¹</label>
            <input type="text" id="find" name="find" placeholder="ä¾‹å¦‚: IMG_" />
            <label for="replace">æ›¿æ¢ä¸º</label>
            <input
              type="text"
              id="replace"
              name="replace"
              placeholder="ä¾‹å¦‚: æ—…è¡Œç…§ç‰‡-"
            />
          </div>

          <div id="tab-sequence" class="tab-content">
            <fieldset>
              <legend>åºåˆ—å·ä½ç½®</legend>
              <label for="pos-prefix">
                <input
                  type="radio"
                  id="pos-prefix"
                  name="position"
                  value="prefix"
                  checked
                />
                å‰ç¼€
              </label>
              <label for="pos-suffix">
                <input
                  type="radio"
                  id="pos-suffix"
                  name="position"
                  value="suffix"
                />
                åç¼€
              </label>
            </fieldset>
            <label for="start">èµ·å§‹æ•°å­—</label>
            <input type="number" id="start" name="start" value="1" />
            <label for="digits">æ•°å­—ä½æ•° (ä¸è¶³è¡¥0)</label>
            <input
              type="number"
              id="digits"
              name="digits"
              value="2"
              placeholder="ä¾‹å¦‚: 2 ä¼šç”Ÿæˆ 01, 02..."
            />
          </div>

          <div id="tab-case" class="tab-content">
  <div class="case-btn-row" style="display:flex;gap:0.5rem;margin-bottom:0.7rem;">
  <button class="outline case-btn">è½¬æ¢ä¸º å…¨éƒ¨å¤§å†™ (UPPERCASE)</button>
  <button class="outline case-btn">è½¬æ¢ä¸º å…¨éƒ¨å°å†™ (lowercase)</button>
  <button class="outline case-btn">è½¬æ¢ä¸º é¦–å­—æ¯å¤§å†™ (Capitalize)</button>
</div>
<style>
.case-btn-row {
  display: flex;
  flex-direction: column !important;
  gap: 0.48rem !important;
}
.case-btn-row .case-btn {
  width: 100% !important;
  min-width: 0 !important;
  margin: 0 !important;
  text-align: center !important;
}
</style>
  <hr style="margin:0.7rem 0 0.9rem 0;border:0;border-top:1.2px dashed #e0e8ef;">
</div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
  <button id="apply-rename" class="primary-action" style="flex:1;">æ‰§è¡Œé‡å‘½å</button>
  <button id="undo-rename" class="secondary-action" style="flex:1;">æ’¤é”€é‡å‘½å</button>
  <button id="redo-rename" class="secondary-action" style="flex:1;">é‡åš</button>
  <button id="clear-all" class="danger-action" style="flex:1;">å…¨éƒ¨æ¸…ç©º</button>
</div>

      </aside>

    </main>

    <script>
      console.log("ğŸš€ å¼€å§‹è®¾ç½®åº”ç”¨");

      document.addEventListener("DOMContentLoaded", async function () {
        // --- å¤§å°å†™æŒ‰é’®ç»„é«˜äº®ä¸åˆ‡æ¢ ---
        document.querySelectorAll('.case-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.case-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
          });
        });
        // --- åºåˆ—å·å‰ç¼€/åç¼€å•é€‰æŒ‰é’®ä¿®å¤ ---
        document.querySelectorAll('input[name="position"]').forEach(function(radio){
          radio.addEventListener('change',function(){
            document.querySelectorAll('input[name="position"]').forEach(r=>{
              if(r!==radio) r.checked=false;
            });
            radio.checked=true;
          });
        });
        // Tabåˆ‡æ¢ä¿®å¤ï¼šä¸ºæ‰€æœ‰.tab-linkæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.tab-link').forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            // ç§»é™¤æ‰€æœ‰tab-linkå’Œtab-contentçš„active
            document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            // å½“å‰tab-linkå’Œå¯¹åº”å†…å®¹åŠ active
            btn.classList.add('active');
            var tabId = btn.getAttribute('data-tab');
            var tabContent = document.getElementById(tabId);
            if(tabContent) tabContent.classList.add('active');
          });
        });
        console.log("ğŸ“‹ DOM å·²åŠ è½½");

        // æ£€æŸ¥ Tauri API
        if (typeof window.__TAURI__ === "undefined") {
          console.error("âŒ Tauri API ä¸å¯ç”¨");
          return;
        }

        console.log("âœ… Tauri API å¯ç”¨");

        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        setupButtons();

        // å°è¯•è®¾ç½®æ‹–æ‹½ï¼ˆå¯èƒ½ä¸å·¥ä½œï¼‰
        await setupDragDrop();
      });

      function setupButtons() {
        const selectFilesBtn = document.getElementById("select-files-btn");
        const applyRenameBtn = document.getElementById("apply-rename");
        const clearAllBtn = document.getElementById("clear-all");

        selectFilesBtn.addEventListener("click", async () => {
          try {
            const { open } = window.__TAURI__.dialog;
            const selected = await open({
              multiple: true,
              directory: false,
            });

            if (selected) {
              const files = Array.isArray(selected) ? selected : [selected];
              console.log("é€‰ä¸­çš„æ–‡ä»¶:", files);
              displayFiles(files);
            }
          } catch (error) {
            console.error("æ–‡ä»¶é€‰æ‹©å¤±è´¥:", error);
            alert("æ–‡ä»¶é€‰æ‹©å¤±è´¥: " + error.message);
          }
        });

        // æ‰§è¡Œé‡å‘½åæŒ‰é’®
        applyRenameBtn.addEventListener("click", async () => {
          await executeRename();
        });

        // æ¸…ç©ºæŒ‰é’®
        clearAllBtn.addEventListener("click", () => {
          clearAll();
        });

        // å®æ—¶é¢„è§ˆ
        const findInput = document.getElementById("find");
        const replaceInput = document.getElementById("replace");

        findInput.addEventListener("input", updatePreview);
        replaceInput.addEventListener("input", updatePreview);
      }

      async function setupDragDrop() {
        try {
          const { listen } = window.__TAURI__.event;

          // å°è¯•å¤šç§å¯èƒ½çš„äº‹ä»¶åç§°
          const eventNames = [
            "tauri://file-drop",
            "tauri://drag-drop",
            "file-drop",
            "drag-drop",
          ];

          for (const eventName of eventNames) {
            try {
              await listen(eventName, (event) => {
                console.log(`ğŸ‰ æ£€æµ‹åˆ°äº‹ä»¶ ${eventName}:`, event);
                console.log(`ğŸ‰ äº‹ä»¶è½½è·:`, event.payload);

                // æ£€æŸ¥è½½è·çš„ç»“æ„
                if (event.payload) {
                  if (Array.isArray(event.payload)) {
                    // å¦‚æœè½½è·ç›´æ¥æ˜¯æ•°ç»„
                    displayFiles(event.payload);
                  } else if (
                    event.payload.paths &&
                    Array.isArray(event.payload.paths)
                  ) {
                    // å¦‚æœè½½è·æœ‰ paths å±æ€§
                    displayFiles(event.payload.paths);
                  } else if (typeof event.payload === "object") {
                    // å¦‚æœè½½è·æ˜¯å¯¹è±¡ï¼Œå°è¯•æ‰¾åˆ°æ–‡ä»¶è·¯å¾„
                    console.log("ğŸ” è½½è·å¯¹è±¡ç»“æ„:", Object.keys(event.payload));

                    // å°è¯•å¸¸è§çš„å±æ€§å
                    const possibleKeys = [
                      "files",
                      "items",
                      "data",
                      "filePaths",
                    ];
                    let found = false;

                    for (const key of possibleKeys) {
                      if (
                        event.payload[key] &&
                        Array.isArray(event.payload[key])
                      ) {
                        displayFiles(event.payload[key]);
                        found = true;
                        break;
                      }
                    }

                    if (!found) {
                      console.log(
                        "æ£€æµ‹åˆ°æ‹–æ‹½ï¼Œä½†æ— æ³•è§£ææ–‡ä»¶è·¯å¾„ã€‚è½½è·ç»“æ„: " +
                          Object.keys(event.payload).join(", ")
                      );
                    }
                  } else {
                    console.log("ğŸ¤” æœªçŸ¥çš„è½½è·æ ¼å¼:", typeof event.payload);
                  }
                } else {
                  console.log("æ£€æµ‹åˆ°æ‹–æ‹½äº‹ä»¶ï¼Œä½†æ²¡æœ‰è½½è·æ•°æ®");
                }
              });
              console.log(`âœ… ç›‘å¬äº‹ä»¶: ${eventName}`);
            } catch (e) {
              console.log(`âŒ æ— æ³•ç›‘å¬äº‹ä»¶: ${eventName}`);
            }
          }

          // ä¹Ÿå°è¯•æ‚¬åœå’Œå–æ¶ˆäº‹ä»¶
          try {
            await listen("tauri://file-drop-hover", (event) => {
              console.log("ğŸ¯ æ‹–æ‹½æ‚¬åœ");
              document.body.style.backgroundColor = "#f0f8ff";
            });

            await listen("tauri://file-drop-cancelled", (event) => {
              console.log("âŒ æ‹–æ‹½å–æ¶ˆ");
              document.body.style.backgroundColor = "";
            });
          } catch (e) {
            console.log("âŒ æ— æ³•è®¾ç½®æ‚¬åœ/å–æ¶ˆäº‹ä»¶");
          }
        } catch (error) {
          console.error("âŒ æ‹–æ‹½è®¾ç½®å¤±è´¥:", error);
        }
      }

      function displayFiles(files) {
        const tbody = document.querySelector("tbody");
        tbody.innerHTML = "";

        files.forEach((file, index) => {
          const fileName = file.split("/").pop() || file.split("\\\\").pop();
          const row = document.createElement("tr");
          row.innerHTML = `
            <th scope="row">${index + 1}</th>
            <td>${fileName}</td>
            <td class="preview-highlight">å‡†å¤‡é‡å‘½å</td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById(
          "file-count"
        ).textContent = `å·²åŠ è½½ ${files.length} ä¸ªæ–‡ä»¶`;
        console.log("ğŸ“ æ˜¾ç¤ºæ–‡ä»¶:", files);
      }

      // å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ–‡ä»¶åˆ—è¡¨
      let currentFiles = [];

      // å¤„ç†æ–‡ä»¶å¤¹
      async function handleFolders(folders) {
        console.log("å¤„ç†æ–‡ä»¶å¤¹:", folders);

        try {
          const { invoke } = window.__TAURI__.core;

          if (folders.length === 1) {
            // å•ä¸ªæ–‡ä»¶å¤¹ï¼šå±•å¼€å†…éƒ¨æ–‡ä»¶
            console.log("å•ä¸ªæ–‡ä»¶å¤¹æ¨¡å¼ï¼šå±•å¼€å†…éƒ¨æ–‡ä»¶");
            const files = await invoke("get_files_from_paths", {
              paths: folders,
            });
            console.log("å±•å¼€çš„æ–‡ä»¶:", files);
            displayFiles(files);
          } else {
            // å¤šä¸ªæ–‡ä»¶å¤¹ï¼šé‡å‘½åæ–‡ä»¶å¤¹æœ¬èº«
            console.log("å¤šä¸ªæ–‡ä»¶å¤¹æ¨¡å¼ï¼šé‡å‘½åæ–‡ä»¶å¤¹æœ¬èº«");
            displayFiles(folders);
          }
        } catch (error) {
          console.error("å¤„ç†æ–‡ä»¶å¤¹å¤±è´¥:", error);
          alert("å¤„ç†æ–‡ä»¶å¤¹å¤±è´¥: " + error.message);
        }
      }

      // æ™ºèƒ½å¤„ç†é€‰ä¸­çš„é¡¹ç›®
      async function handleSelectedItems(items) {
        console.log("å¤„ç†é€‰ä¸­çš„é¡¹ç›®:", items);

        try {
          const { invoke } = window.__TAURI__.core;

          // æ£€æŸ¥é€‰ä¸­é¡¹ç›®çš„ç±»å‹
          const itemTypes = await Promise.all(
            items.map(async (item) => {
              try {
                // è°ƒç”¨åç«¯æ£€æŸ¥æ˜¯æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹
                const result = await invoke("get_files_from_paths", {
                  paths: [item],
                });
                return {
                  path: item,
                  isDirectory:
                    result.length > 1 ||
                    (result.length === 1 && result[0] !== item),
                  files: result,
                };
              } catch (error) {
                console.error("æ£€æŸ¥é¡¹ç›®ç±»å‹å¤±è´¥:", item, error);
                return {
                  path: item,
                  isDirectory: false,
                  files: [item],
                };
              }
            })
          );

          console.log("é¡¹ç›®ç±»å‹åˆ†æ:", itemTypes);

          // åˆ¤æ–­å¤„ç†é€»è¾‘
          const directories = itemTypes.filter((item) => item.isDirectory);
          const files = itemTypes.filter((item) => !item.isDirectory);

          let finalFiles = [];

          if (directories.length === 1 && files.length === 0) {
            // å•ä¸ªæ–‡ä»¶å¤¹ï¼šé‡å‘½åæ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶
            console.log("å•ä¸ªæ–‡ä»¶å¤¹æ¨¡å¼ï¼šé‡å‘½åæ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶");
            finalFiles = directories[0].files;
          } else if (directories.length > 1 && files.length === 0) {
            // å¤šä¸ªæ–‡ä»¶å¤¹ï¼šé‡å‘½åæ–‡ä»¶å¤¹æœ¬èº«
            console.log("å¤šä¸ªæ–‡ä»¶å¤¹æ¨¡å¼ï¼šé‡å‘½åæ–‡ä»¶å¤¹æœ¬èº«");
            finalFiles = directories.map((dir) => dir.path);
          } else if (files.length > 0 && directories.length === 0) {
            // åªæœ‰æ–‡ä»¶ï¼šé‡å‘½åæ–‡ä»¶
            console.log("æ–‡ä»¶æ¨¡å¼ï¼šé‡å‘½åæ–‡ä»¶");
            finalFiles = files.map((file) => file.path);
          } else {
            // æ··åˆæ¨¡å¼ï¼šæ–‡ä»¶å¤¹å±•å¼€ä¸ºå†…éƒ¨æ–‡ä»¶ï¼Œæ–‡ä»¶ä¿æŒåŸæ ·
            console.log("æ··åˆæ¨¡å¼ï¼šæ–‡ä»¶å¤¹å±•å¼€ï¼Œæ–‡ä»¶ä¿æŒ");
            finalFiles = [];

            // æ·»åŠ æ‰€æœ‰æ–‡ä»¶
            files.forEach((file) => {
              finalFiles.push(file.path);
            });

            // æ·»åŠ æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶
            directories.forEach((dir) => {
              finalFiles.push(...dir.files);
            });
          }

          console.log("æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨:", finalFiles);
          displayFiles(finalFiles);
        } catch (error) {
          console.error("å¤„ç†é€‰ä¸­é¡¹ç›®å¤±è´¥:", error);
          alert("å¤„ç†é€‰ä¸­é¡¹ç›®å¤±è´¥: " + error.message);
        }
      }

      // æ›´æ–° displayFiles å‡½æ•°ä»¥ä¿å­˜æ–‡ä»¶åˆ—è¡¨
      function displayFiles(files) {
        currentFiles = files; // ä¿å­˜åˆ°å…¨å±€å˜é‡

        const tbody = document.querySelector("tbody");
        tbody.innerHTML = "";

        files.forEach((file, index) => {
          const fileName = file.split("/").pop() || file.split("\\\\").pop();
          const previewName = getPreviewName(fileName);
          const hasChange = previewName !== fileName;

          const row = document.createElement("tr");
          row.innerHTML = `
            <th scope="row">${index + 1}</th>
            <td>${fileName}</td>
            <td class="preview-cell ${
              hasChange ? "preview-highlight" : "dimmed"
            }">
                ${hasChange ? previewName : "(æ— å˜åŒ–)"}
            </td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById(
          "file-count"
        ).textContent = `å·²åŠ è½½ ${files.length} ä¸ªæ–‡ä»¶`;
        console.log("ğŸ“ æ˜¾ç¤ºæ–‡ä»¶:", files);
      }

      // è·å–é¢„è§ˆåç§°
      function getPreviewName(fileName) {
        const activeTab = document.querySelector(".tab-content.active");
        if (!activeTab) return fileName;

        const tabId = activeTab.id;

        if (tabId === "tab-replace") {
          const findText = document.getElementById("find").value;
          const replaceText = document.getElementById("replace").value;

          if (!findText) return fileName;

          return fileName.replace(new RegExp(findText, "g"), replaceText);
        }

        return fileName;
      }

      // æ‰§è¡Œé‡å‘½å
      async function executeRename() {
        if (currentFiles.length === 0) {
          alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
          return;
        }

        const findText = document.getElementById("find").value;
        const replaceText = document.getElementById("replace").value;

        if (!findText) {
          alert("è¯·è¾“å…¥è¦æŸ¥æ‰¾çš„å†…å®¹");
          return;
        }

        try {
          const { invoke } = window.__TAURI__.core;
          const result = await invoke("execute_rename", {
            filePaths: currentFiles,
            rule: {
              find: findText,
              replace: replaceText || "",
            },
          });

          console.log("é‡å‘½åç»“æœ:", result);

          if (result.success) {
            if (result.renamed_count > 0) {
              alert(`æˆåŠŸé‡å‘½å ${result.renamed_count} ä¸ªæ–‡ä»¶`);
              clearAll();
            } else {
              alert(result.error_message || "æ²¡æœ‰æ–‡ä»¶éœ€è¦é‡å‘½å");
            }
          } else {
            alert(`é‡å‘½åå¤±è´¥: ${result.error_message || "æœªçŸ¥é”™è¯¯"}`);
          }
        } catch (error) {
          console.error("è°ƒç”¨åç«¯å¤±è´¥:", error);
          alert("æ‰§è¡Œé‡å‘½åæ—¶å‘ç”Ÿé”™è¯¯: " + error.message);
        }
      }

      // æ¸…ç©ºæ‰€æœ‰
      function clearAll() {
        currentFiles = [];
        const tbody = document.querySelector("tbody");
        tbody.innerHTML = "";
        document.getElementById("file-count").textContent = "å·²åŠ è½½ 0 ä¸ªæ–‡ä»¶";

        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById("find").value = "";
        document.getElementById("replace").value = "";
      }

      // æ›´æ–°é¢„è§ˆ
      function updatePreview() {
        if (currentFiles.length === 0) return;

        const previewCells = document.querySelectorAll(".preview-cell");

        currentFiles.forEach((file, index) => {
          if (index < previewCells.length) {
            const fileName = file.split("/").pop() || file.split("\\\\").pop();
            const previewName = getPreviewName(fileName);
            const cell = previewCells[index];

            if (previewName !== fileName) {
              cell.textContent = previewName;
              cell.className = "preview-cell preview-highlight";
            } else {
              cell.textContent = "(æ— å˜åŒ–)";
              cell.className = "preview-cell dimmed";
            }
          }
        });
      }
    </script>
  <script type="module" src="src/main.js"></script>
</body>
</html>
